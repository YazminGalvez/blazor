@page "/MiVista"
@using blazor.Components.Data
@rendermode InteractiveServer
@inject Servicio.ServicioControlador ServicioControlador
<h3>Juegos</h3>

<style>
    ul {
        list-style-type: none;
        padding-left: 0;
    }

    li {
        margin-bottom: 8px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        li > span {
            flex-grow: 1;
        }

        li button {
            margin-left: 5px;
        }
</style>

<div>
    <input type="checkbox" id="filtroPendientes"
           checked="@ServicioControlador.MostrarSoloPendientes"
           @onchange="CambiarEstadoFiltro" />
    <label for="filtroPendientes">Mostrar solo pendientes</label>
</div>

<div>
    <label for="filtroNombre">Buscar por nombre:</label>
    <input id="filtroNombre"
           value="@ServicioControlador.FiltroNombre"
           @oninput="OnFiltroNombreChanged"
           placeholder="Filtrar por nombre..." />

    <button @onclick="LimpiarFiltroNombre" class="btn btn-secondary btn-sm">Limpiar</button>
</div>


@if (!string.IsNullOrEmpty(Mensaje))
{
    <p style="color: @(Mensaje.StartsWith("Error") ? "red" : "green");">
        @Mensaje
    </p>
}

<ul>
    @foreach (var j in JuegosFiltrados)
    {
        <li>
            @if (juegoEnEdicion?.Identificador == j.Identificador)
            {
                <input @bind="nombreTemporalEdicion" class="form-control" />
                <button @onclick="GuardarEdicion" class="btn btn-success btn-sm">💾</button>
                <button @onclick="CancelarEdicion" class="btn btn-secondary btn-sm">❌</button>
            }
            else
            {
                <span>
                    @j.Nombre
                    (@(j.Jugado ? "Ya jugado" : "Pendiente"))
                </span>
                <input type="checkbox" class="form-check-input" checked="@j.Jugado" @onclick="() => cambiarJugado(j)" />
                <button @onclick="() => IniciarEdicion(j)" class="btn btn-warning btn-sm">✏️</button>
                <button @onclick="() => EliminarJuego(j)" class="btn btn-danger btn-sm">🗑️</button>
            }
        </li>
    }
</ul>

<div>
    <input @bind="newJuego.Nombre"
           placeholder="Nuevo juego" />
    <button @onclick="AgregarJuego">Agregar Juego</button>
</div>

@code {
    private List<Juego> juegos = new();
    private Juego newJuego = new();
    private string Mensaje = string.Empty;

    private Juego? juegoEnEdicion = null;
    private string nombreTemporalEdicion = "";

    private IEnumerable<Juego> JuegosFiltrados
    {
        get
        {
            IEnumerable<Juego> filtrados = juegos;

            if (ServicioControlador.MostrarSoloPendientes)
            {
                filtrados = filtrados.Where(j => !j.Jugado);
            }

            if (!string.IsNullOrWhiteSpace(ServicioControlador.FiltroNombre))
            {
                filtrados = filtrados.Where(j =>
                    j.Nombre.Contains(ServicioControlador.FiltroNombre, StringComparison.OrdinalIgnoreCase));
            }

            return filtrados.ToList();
        }
    }

    private async Task CambiarEstadoFiltro(ChangeEventArgs e)
    {
        bool nuevoEstado = (bool)e.Value;
        ServicioControlador.MostrarSoloPendientes = nuevoEstado;
        await ServicioControlador.GuardarEstadoFiltro();
        StateHasChanged();
    }

    private async Task OnFiltroNombreChanged(ChangeEventArgs e)
    {
        ServicioControlador.FiltroNombre = e.Value?.ToString() ?? string.Empty;
        await ServicioControlador.GuardarFiltroNombre();
    }

    private async Task LimpiarFiltroNombre()
    {
        ServicioControlador.FiltroNombre = string.Empty;
        await ServicioControlador.GuardarFiltroNombre();
        StateHasChanged();
    }

    private async Task cambiarJugado(Juego juego)
    {
        Mensaje = string.Empty;
        juego.Jugado = !juego.Jugado;
        await ServicioControlador.ActualizarJuego(juego);
        juegos = await ServicioControlador.ObtenerJuegos();
        StateHasChanged();
    }

    private async Task AgregarJuego()
    {
        Mensaje = string.Empty;
        if (!string.IsNullOrWhiteSpace(newJuego.Nombre))
        {
            if (juegos.Any(j => j.Nombre.Equals(newJuego.Nombre, StringComparison.OrdinalIgnoreCase)))
            {
                Mensaje = $"Error: El juego '{newJuego.Nombre}' ya existe.";
            }
            else
            {
                await ServicioControlador.AgregarJuego(newJuego);
                juegos = await ServicioControlador.ObtenerJuegos();
                Mensaje = $"Éxito: Juego '{newJuego.Nombre}' agregado.";
                newJuego = new();
            }
            StateHasChanged();
        }
    }

    private void IniciarEdicion(Juego juego)
    {
        juegoEnEdicion = juego;
        nombreTemporalEdicion = juego.Nombre;
        Mensaje = string.Empty;
        StateHasChanged();
    }

    private void CancelarEdicion()
    {
        juegoEnEdicion = null;
        StateHasChanged();
    }

    private async Task GuardarEdicion()
    {
        if (juegoEnEdicion == null || string.IsNullOrWhiteSpace(nombreTemporalEdicion))
        {
            Mensaje = "Error: El nombre no puede estar vacío.";
            StateHasChanged();
            return;
        }

        if (juegos.Any(j => j.Nombre.Equals(nombreTemporalEdicion, StringComparison.OrdinalIgnoreCase) && j.Identificador != juegoEnEdicion.Identificador))
        {
            Mensaje = $"Error: El nombre '{nombreTemporalEdicion}' ya existe.";
            StateHasChanged();
            return;
        }

        string nombreAntiguo = juegoEnEdicion.Nombre;

        await ServicioControlador.ActualizarNombreJuego(juegoEnEdicion.Identificador, nombreTemporalEdicion);

        juegos = await ServicioControlador.ObtenerJuegos();
        Mensaje = $"Éxito: Juego '{nombreAntiguo}' actualizado a '{nombreTemporalEdicion}'.";

        juegoEnEdicion = null;
        StateHasChanged();
    }

    private async Task EliminarJuego(Juego juegoAEliminar)
    {
        Mensaje = string.Empty;
        await ServicioControlador.EliminarJuego(juegoAEliminar.Identificador);
        juegos = await ServicioControlador.ObtenerJuegos();
        Mensaje = $"Éxito: Juego '{juegoAEliminar.Nombre}' eliminado.";
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await ServicioControlador.CargarEstadoFiltro();
        await ServicioControlador.CargarFiltroNombre();
        juegos = await ServicioControlador.ObtenerJuegos();
    }
}